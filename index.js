"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var r=[],i=!0,n=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);i=!0);}catch(t){n=!0,o=t}finally{try{!i&&s.return&&s.return()}finally{if(n)throw o}}return r}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}!function(){var A={"actors/rockman/idle":[512,73,21,24],"actors/rockman/idle-blink":[512,97,21,24],"actors/rockman/run-0":[512,51,24,22],"actors/rockman/run-1":[512,167,16,24],"actors/rockman/run-2":[512,145,21,22],"actors/rockman/run-step":[512,121,20,24],"actors/rockman/jump":[512,0,26,30],"actors/rockman/slide":[512,30,27,21],"stages/overworld/backdrop":[0,0,512,240]},t={overworld:{gravity:.25,size:[32,15],blocks:[[4,2,4,1],[6,3,2,2],[0,4,1,11],[8,4,2,1],[1,5,1,10],[23,5,2,4],[2,6,1,2],[3,7,1,1],[12,7,5,1],[14,8,4,7],[25,8,2,1],[6,9,2,6],[18,9,1,6],[30,9,2,6],[10,10,2,1],[19,10,1,5],[4,11,4,4],[20,11,1,4],[28,11,4,4],[21,12,1,3],[2,13,30,2]]}};var z={rockman:{size:[16,24],stats:{speed:1.296875,jump:4.87109375},sprites:[{id:"idle",path:"sprites/idle.png",offset:[-3,1]},{id:"idle-blink",path:"sprites/idle-blink.png",offset:[-3,1]},{id:"run-0",path:"sprites/run-0.png",offset:[-5,3]},{id:"run-1",path:"sprites/run-1.png",offset:[-2,1]},{id:"run-2",path:"sprites/run-2.png",offset:[-6,3]},{id:"run-step",path:"sprites/run-step.png",offset:[-3,1]},{id:"jump",path:"sprites/jump.png",offset:[-5,0]},{id:"slide",path:"sprites/slide.png",offset:[-2,5]}],actions:{move:function(t,e){var r=0;if("left"===e)r=-1;else{if("right"!==e)return;r=1}t.facing=r,t.ground&&("idle"===t.state.id?(t.velocity[0]=r,t.state.id="run-start",t.state.time=0):"land"!==t.state.id&&"run-stop"!==t.state.id||(t.state.id="run",t.state.time=0));t.ground&&"run"!==t.state.id||(t.velocity[0]=t.stats.speed*r)},stop:function(t){t.ground&&"run-stop"!==t.state.id&&("run-start"===t.state.id?(t.state.id="idle",t.state.time=0):"run"===t.state.id&&(t.state.id="run-stop",t.state.time=0));t.velocity[0]=0},jump:function(t){t.ground&&(t.velocity[1]=-t.stats.jump,t.state.id="jump",t.state.time=0)},fall:function(t){!t.ground&&t.velocity[1]<0&&(t.velocity[1]=0)},update:function(t){"run-start"===t.state.id&&(7===t.state.time?(t.state.id="run",t.state.time=0):0<t.state.time&&(t.velocity[0]=0));"run-stop"===t.state.id&&7===t.state.time&&(t.state.id="idle",t.state.time=0);"land"===t.state.id&&2===t.state.time&&(t.state.id="idle",t.state.time=0)},render:function(t,e){var r=function(t){if(t.ground){if("idle"===t.state.id)return 58<=t.state.time%60?"idle-blink":"idle";if("run"===t.state.id){var e=Math.floor(t.state.time/7)%4;return 3===e?"run-1":"run-"+e}if("run-start"===t.state.id||"run-stop"===t.state.id)return"run-step";if("land"===t.state.id)return"run-0"}return"jump"}(t),i=-1===t.facing?"left":"right",n=e[r][i].image,o=e[r][i].offset,a=t.view,s=t.hitbox,l=_slicedToArray(s.position,2),u=l[0],d=l[1],f=_slicedToArray(s.halfsize,2),c=f[0],p=f[1],v=Math.round(u-c+o[0]),h=Math.round(d-p+o[1]);a.width=n.width,a.height=n.height,a.style.left=v+"px",a.style.top=h+"px",a.getContext("2d").drawImage(n,0,0)}}}},d=r,f=i,c=n,p=o,v=function(t,e){return r(t)<i(e)&&i(t)>r(e)&&n(t)<o(e)&&o(t)>n(e)};function r(t,e){if(void 0===e)return t.position[0]-t.halfsize[0];t.position[0]=e+t.halfsize[0]}function i(t,e){if(void 0===e)return t.position[0]+t.halfsize[0];t.position[0]=e-t.halfsize[0]}function n(t,e){if(void 0===e)return t.position[1]-t.halfsize[1];t.position[1]=e+t.halfsize[1]}function o(t,e){if(void 0===e)return t.position[1]+t.halfsize[1];t.position[1]=e-t.halfsize[1]}var m={update:function(t){var e=!0,r=!1,i=void 0;try{for(var n,o=t.actors[Symbol.iterator]();!(e=(n=o.next()).done);e=!0){var a=n.value;s(t,a,[a.velocity[0],0]),s(t,a,[0,a.velocity[1]]),a.velocity[1]+=t.gravity,a.state.time++}}catch(t){r=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(r)throw i}}}};function s(t,e,r){e.hitbox.position[0]+=r[0],e.hitbox.position[1]+=r[1],d(e.hitbox)<0?d(e.hitbox,0):512<f(e.hitbox)&&f(e.hitbox,512);var i=null,n=!0,o=!1,a=void 0;try{for(var s,l=t.blocks[Symbol.iterator]();!(n=(s=l.next()).done);n=!0){var u=s.value;v(e.hitbox,u.hitbox)&&(r[0]<0?(d(e.hitbox,f(u.hitbox)),e.velocity[0]=0):0<r[0]&&(f(e.hitbox,d(u.hitbox)),e.velocity[0]=0),r[1]<0?(c(e.hitbox,p(u.hitbox)),e.velocity[1]=0):0<r[1]&&(p(e.hitbox,c(u.hitbox)),e.velocity[1]=0,i=u))}}catch(t){o=!0,a=t}finally{try{!n&&l.return&&l.return()}finally{if(o)throw a}}r[1]&&(e.ground||(e.state.id="land",e.state.time=0),e.ground=i)}var e={left:["ArrowLeft","KeyA"],right:["ArrowRight","KeyD"],jump:["ArrowUp","KeyW"]};function j(t){if(t instanceof Element)return t;if(!t||"object"!==(void 0===t?"undefined":_typeof(t)))return document.createTextNode(t);var e=t.tag,r=t.attributes,i=t.children,n=document.createElement(e);for(var o in r){var a=r[o];n[o]=a,n.setAttribute(o,a)}for(var s=0;s<i.length;s++){var l=j(i[s]);n.appendChild(l)}return n}var S=function t(e){var r="";for(var i in e){var n=e[i];r&&(r+=";"),"object"===(void 0===n?"undefined":_typeof(n))?r+=i+"{"+t(n)+"}":r+=i+":"+n}return r};var a,l={name:"rockman",state:{id:"fall",time:0},stats:z.rockman.stats,hitbox:{halfsize:z.rockman.size.map(function(t){return t/2}),position:[112,132]},velocity:[0,0],facing:1,ground:null,view:j({tag:"canvas",attributes:{class:"actor rockman"},children:[]})},_={stage:{time:0,name:"overworld",gravity:t.overworld.gravity,blocks:t.overworld.blocks.map(function(t){var e=_slicedToArray(t,4),r=e[0],i=e[1],n=e[2],o=e[3];return{hitbox:{halfsize:[16*n/2,16*o/2],position:[16*(r+n/2),16*(i+o/2)]}}}),actors:[l]},viewport:{size:[256,240],position:[0,0]},input:{held:function(t,i){var n={},o=!1;function e(t){var e=null;if(i)for(var e in i){for(var r=0;r<i[e].length&&i[e][r]!==t.code;r++);if(r<i[e].length)break;e=null}e||(e=t.code),"keydown"===t.type?n[e]||(n[e]=1):"keyup"===t.type&&(n[e]=0),o||(o=!0,requestAnimationFrame(a))}function a(){for(var t in n)n[t]&&n[t]++;requestAnimationFrame(a)}return t.addEventListener("keydown",e),t.addEventListener("keyup",e),n}(window,e),prev:{}}},E=null,C=null;function T(){var t=_.stage,e=t.actors[0],r=g.resolve(_.input),i=!0,n=!1,o=void 0;try{for(var a,s=r[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l,u=a.value;(l=z[e.name].actions)[u.type].apply(l,[e].concat(_toConsumableArray(u.args)))}}catch(t){n=!0,o=t}finally{try{!i&&s.return&&s.return()}finally{if(n)throw o}}m.update(t);var d=!0,f=!1,c=void 0;try{for(var p,v=t.actors[Symbol.iterator]();!(d=(p=v.next()).done);d=!0){var h=p.value;z[h.name].actions.update(h),z[h.name].actions.render(h,E.actors[h.name])}}catch(t){f=!0,c=t}finally{try{!d&&v.return&&v.return()}finally{if(f)throw c}}var y=-Math.round(e.hitbox.position[0]-_.viewport.size[0]/2);0<=y&&(y=0),y<-256&&(y=-256),C.style.left=y+"px",g.update(_.input),requestAnimationFrame(T)}(a="sprites.png",new Promise(function(t,e){var r=new Image;r.src=a,r.onload=function(){t(r)},r.onerror=function(){e(new Error("Failed to load image `"+a+"`"))}})).then(function(t){for(var e in E=function(t,e){var r={};for(var i in e){var n=_slicedToArray(e[i],4),o=n[0],a=n[1],s=n[2],l=n[3],u=document.createElement("canvas");u.width=s,u.height=l;var d=u.getContext("2d");d.drawImage(t,-o,-a);for(var f=i.split("/"),c=r,p=null,v=0;v<f.length-1;v++)p=f[v],c[p]||(c[p]={}),c=c[p];p=f[v],c[p]=u}return r}(t,A),z){var r=!0,i=!1,n=void 0;try{for(var o,a=z[e].sprites[Symbol.iterator]();!(r=(o=a.next()).done);r=!0){var s=o.value,l=E.actors[e][s.id],u=document.createElement("canvas"),d=u.getContext("2d");u.width=l.width,u.height=l.height,d.scale(-1,1),d.drawImage(l,-l.width,0),E.actors[e][s.id]={right:{image:l,offset:s.offset},left:{image:u,offset:[-l.width-s.offset[0]+z.rockman.size[0],s.offset[1]]}}}}catch(t){i=!0,n=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw n}}}var f=!0,c=!1,p=void 0;try{for(var v,h=_.stage.actors[Symbol.iterator]();!(f=(v=h.next()).done);f=!0){var y=v.value;z[y.name].actions.render(y,E.actors[y.name])}}catch(t){c=!0,p=t}finally{try{!f&&h.return&&h.return()}finally{if(c)throw p}}var m,g,b,w,x=j((g=E,b=(m=_).stage,w=m.viewport,{tag:"div",attributes:{class:"viewport",style:S({width:w.size[0]+"px",height:w.size[1]+"px"})},children:[{tag:"div",attributes:{class:"viewport-inner"},children:[{tag:"div",attributes:{class:"stage"},children:[{tag:"div",attributes:{class:"layer background"},children:[g.stages[b.name].backdrop]},{tag:"div",attributes:{class:"layer foreground"},children:[].concat(_toConsumableArray(b.actors.map(function(t){return t.view})))}]}]}]}));function k(t){x.style.transform="scale("+(window.innerWidth<=window.innerHeight?window.innerWidth/_.viewport.size[0]:window.innerHeight/_.viewport.size[1])+")"}document.body.appendChild(x),requestAnimationFrame(T),C=x.children[0],window.addEventListener("resize",k),k()});var g={update:function(t){Object.assign(t.prev,t.held)},resolve:function(t){var e=[];return t.held.left&&!t.held.right?e.push({type:"move",args:["left"]}):t.held.right&&!t.held.left?e.push({type:"move",args:["right"]}):((t.prev.left||t.prev.right)&&!t.held.left&&!t.held.right||(t.prev.left&&!t.prev.right||t.prev.right&&!t.prev.left)&&t.held.left&&t.held.right)&&e.push({type:"stop",args:[]}),t.held.jump&&!t.prev.jump?e.push({type:"jump",args:[]}):t.held.jump||e.push({type:"fall",args:[]}),e}}}();